# Hardening

### Make functions
 #### Compiles or passes on:
  * Make pedantic
  * Make testsanitizers
  
 #### Strategy
  * Let the fuzzer run for 30 minutes
  * Collect a few binaries that are generated for which the IJVM crashed
  * Adjust the code so it can handle the binaries properly
  * Fuzz again
  
 #### 1st iteration
  * 1 cyle, 445 total paths, 144 unique crashes, 87 unique hangs
  * Remove the assert functions in machine.c and replace them with if statements, exit the program if it doesn't meet the condition.
  * Make the function 'pop' quit the program if it is called, but the stack is empty.
  
 #### 2nd iteration
  * 4 cycles, 347 paths, 109 unique crashes, 34 unique hangs
  * Fix the function 'finished', incorporate it in the step function, before the function only existed to pass testadvanced7.
  * Adjust getters in machine.c with if-statements and exit the program if it doesn't meet the if condition.
  * Adjust all the functions that use pop to check for the contents of the stack, if it is not possible to pop then quit the program.
  
 Got stuck on a heap-buffer-overflow that I wasn't able to solve in time.

# Garbage collector

### Strategy
#### Heap
 * Everytime we have to allocate a new array in the heap we give that a boolean called marked, this will later indicate if the array on the heap is still in use by the program or not.
 * Everytime we have to allocate a new array in the heap we give it a reference and push this reference back on the stack.

#### Garbage collector
 * We assume that an array is not in use when its reference is not in either the stack or in a frame.
 * Everytime we call the garbage collector we will replace our current heap, with a new heap that does not contain the unused arrays.
 * We collect our unused array by checking if the reference of the array is in either the stack or the local variables in the frames, if that is the case we set the boolean value of marked to true. Everything that is unreachable/unused won't have the boolean value marked as true.
 * We determine the size of the new heap by counting the amount of reachable arrays.
 * We initialize a new heap with all the reachable elements, the references stay the same. We reset the boolean marked back to false for all the arrays.
 * Return the new heap.


# Compiling
Requires make and GCC or Clang

Run `make ijvm` to build the ijvm binary

You can enable the debug print (`dprintf`) found in `include/util.h` by
setting the `-DDEBUG` compiler flag (e.g., `make clean && make testbasic CFLAGS=-DDEBUG`).

# Running a binary
Run an IJVM program using `./ijvm binary`. For example `./ijvm files/advanced/Tanenbaum.ijvm`.

## Adding header files
Add your header files to the folder `include`.

# Testing
To run a specific test run `make run_testX` (e.g. `make run_test1`).

* To run all basic tests, do `make testbasic`.
* To run all advanced tests, do `make testadvanced`.
* Check for memory leaks using `make testleaks`
* Check for memory errors/ undeifned behavior `make testsanitizers` (requires LLVM)
* To compile with pedantic flags: `make pedantic`

You can debug the tests by running running the binaries generated by
`make build_tests` through GDB.

# Handing in
Generate a gzipped tarball of your project using the `make dist` command.
Make sure to double check that all your required files are included in the tarball.

# Compatibility
You need a valid C11 compiler, such as clang or gcc, as well as glibc. Do not 
use any non-standard libraries.

This skeleton works on Linux and MacOS. Windows users can install a Linux VM, or
follow the instructions below.

# Windows
To develop on Windows, we recommend using the [Windows Subsystem for Linux](https://docs.microsoft.com/en-us/windows/wsl/install-win10),
and installing Ubuntu from the Microsoft Store. Once you have gone through the
setup steps, you can access the Linux command line by executing `bash` from
the Windows command line. You can access your files in the Windows file system
through mount points (e.g. `cd /mnt/c/Users/<username>/Desktop`).

Both glibc, gcc, and make are included in the package `build-essential`. To 
install this package, execute the following commands:

* `sudo apt-get update`
* `sudo apt-get install build-essential`

Now you can compile the project by navigating to this directory and executing
the `make` command.

# Tools
You can install the goJASM assembler by executing `make tools`. This will
download a goJASM executable in the tools directory.
